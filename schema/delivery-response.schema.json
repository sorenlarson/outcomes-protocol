{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://outcomes-protocol.com/schema/delivery-response.schema.json",
  "title": "Delivery Response",
  "description": "Schema for the provider's response to an outcome request",
  "type": "object",
  "required": ["response_id", "request_id", "status", "timestamps"],
  "properties": {
    "response_id": {
      "type": "string",
      "description": "Unique identifier for this response"
    },
    "request_id": {
      "type": "string",
      "format": "uuid",
      "description": "Reference to the original request"
    },
    "status": {
      "type": "string",
      "enum": ["completed", "failed", "escalated", "pending", "cancelled"],
      "description": "Overall status of the outcome"
    },
    "outcome": {
      "type": ["object", "null"],
      "description": "The delivered outcome (null if escalated/failed)",
      "properties": {
        "type": {
          "type": "string",
          "description": "Outcome type from taxonomy"
        },
        "result": {
          "type": "object",
          "description": "Outcome-specific result data"
        },
        "artifacts": {
          "type": "array",
          "items": { "$ref": "#/$defs/artifact" },
          "description": "Produced artifacts"
        }
      }
    },
    "success_criteria_results": {
      "type": "object",
      "description": "Evaluation of each success criterion",
      "properties": {
        "required": {
          "type": "array",
          "items": { "$ref": "#/$defs/criterion_result" }
        },
        "optional": {
          "type": "array",
          "items": { "$ref": "#/$defs/criterion_result" }
        },
        "overall_success": {
          "type": "boolean",
          "description": "Whether all required criteria passed"
        }
      }
    },
    "delivery_metrics": {
      "$ref": "#/$defs/delivery_metrics",
      "description": "Performance and cost metrics"
    },
    "escalation": {
      "type": ["object", "null"],
      "description": "Escalation details if status is 'escalated'",
      "$ref": "#/$defs/escalation_details"
    },
    "guarantee": {
      "type": "object",
      "description": "Guarantee status for this outcome",
      "properties": {
        "level": {
          "type": "string",
          "enum": ["none", "basic", "standard", "full"]
        },
        "coverage_active": {
          "type": "boolean"
        },
        "claim_eligible_until": {
          "type": "string",
          "format": "date-time"
        },
        "premium_charged": {
          "type": "number",
          "minimum": 0
        }
      }
    },
    "execution_engine": {
      "type": "object",
      "description": "Information about the execution engine (model + harness) that handled this outcome",
      "properties": {
        "engine_id": {
          "type": "string",
          "description": "Unique identifier for this execution engine"
        },
        "model": {
          "type": "string",
          "description": "AI model used (e.g., 'claude-opus-4', 'gpt-5')"
        },
        "model_version": {
          "type": "string",
          "description": "Specific model version identifier"
        },
        "harness": {
          "type": "string",
          "description": "Execution harness (e.g., 'claude-code', 'devin', 'custom-mcp')"
        },
        "harness_version": {
          "type": "string",
          "description": "Harness version identifier"
        },
        "vendor": {
          "type": "string",
          "description": "Vendor providing this execution engine (e.g., 'anthropic', 'openai')"
        },
        "quality_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 5,
          "description": "Historical quality score for this engine on this outcome type"
        },
        "capabilities": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Capabilities this engine provides"
        }
      }
    },
    "timestamps": {
      "type": "object",
      "required": ["requested_at"],
      "properties": {
        "requested_at": {
          "type": "string",
          "format": "date-time"
        },
        "started_at": {
          "type": "string",
          "format": "date-time"
        },
        "completed_at": {
          "type": "string",
          "format": "date-time"
        },
        "escalated_at": {
          "type": "string",
          "format": "date-time"
        }
      }
    },
    "checkpoints": {
      "type": "array",
      "items": { "$ref": "#/$defs/checkpoint" },
      "description": "Progress checkpoints for long-running outcomes"
    }
  },
  "$defs": {
    "artifact": {
      "type": "object",
      "required": ["type", "content"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["document", "code", "message", "structured_data", "file"],
          "description": "Artifact type"
        },
        "content": {
          "type": "string",
          "description": "Artifact content or reference"
        },
        "mime_type": {
          "type": "string",
          "description": "MIME type of content"
        },
        "metadata": {
          "type": "object",
          "description": "Artifact-specific metadata"
        }
      }
    },
    "criterion_result": {
      "type": "object",
      "required": ["metric", "passed"],
      "properties": {
        "metric": {
          "type": "string",
          "description": "Criterion name"
        },
        "expected": {
          "description": "Expected value or condition"
        },
        "actual": {
          "description": "Actual measured value"
        },
        "passed": {
          "type": "boolean",
          "description": "Whether criterion was met"
        },
        "failure_reason": {
          "type": "string",
          "description": "Explanation if failed"
        }
      }
    },
    "delivery_metrics": {
      "type": "object",
      "properties": {
        "latency_seconds": {
          "type": "number",
          "minimum": 0,
          "description": "Total time from request to completion"
        },
        "tokens_used": {
          "type": "integer",
          "minimum": 0,
          "description": "Total tokens consumed"
        },
        "cost_breakdown": {
          "type": "object",
          "properties": {
            "compute": {
              "type": "number",
              "minimum": 0,
              "description": "Raw compute/inference cost"
            },
            "risk_premium": {
              "type": "number",
              "minimum": 0,
              "description": "Guarantee/risk premium"
            },
            "platform_fee": {
              "type": "number",
              "minimum": 0,
              "description": "Marketplace fee"
            },
            "total": {
              "type": "number",
              "minimum": 0,
              "description": "Total cost to buyer"
            }
          }
        },
        "effort_level": {
          "type": "string",
          "enum": ["minimal", "standard", "thorough", "exhaustive"],
          "description": "Effort level applied"
        },
        "tool_calls": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "tool": { "type": "string" },
              "timestamp": { "type": "string", "format": "date-time" },
              "duration_ms": { "type": "integer" },
              "success": { "type": "boolean" }
            }
          }
        }
      }
    },
    "escalation_details": {
      "type": "object",
      "properties": {
        "handoff_id": {
          "type": "string",
          "description": "Unique ID for the handoff"
        },
        "reason": {
          "type": "object",
          "properties": {
            "trigger": {
              "type": "string",
              "enum": ["confidence_threshold", "max_attempts", "timeout", "explicit_request", "policy_violation", "out_of_scope"]
            },
            "confidence": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            },
            "details": {
              "type": "string"
            }
          }
        },
        "destination": {
          "type": "object",
          "properties": {
            "type": {
              "type": "string"
            },
            "ticket_id": {
              "type": "string"
            },
            "queue_name": {
              "type": "string"
            }
          }
        },
        "summary_provided": {
          "type": "boolean"
        },
        "transcript_provided": {
          "type": "boolean"
        },
        "work_completed_percent": {
          "type": "number",
          "minimum": 0,
          "maximum": 100
        },
        "handoff_payload": {
          "type": "object",
          "description": "Full handoff data sent to destination",
          "properties": {
            "summary": {
              "type": "object",
              "properties": {
                "issue": { "type": "string" },
                "attempted_resolution": { "type": "string" },
                "customer_sentiment": { "type": "string" },
                "recommended_action": { "type": "string" }
              }
            },
            "context": { "type": "object" },
            "priority": { "type": "string" }
          }
        }
      }
    },
    "checkpoint": {
      "type": "object",
      "required": ["timestamp", "progress_percent"],
      "properties": {
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "progress_percent": {
          "type": "number",
          "minimum": 0,
          "maximum": 100
        },
        "current_phase": {
          "type": "string"
        },
        "message": {
          "type": "string"
        },
        "estimated_completion_seconds": {
          "type": "integer",
          "minimum": 0
        }
      }
    }
  }
}
